name: Content Analytics

on:
  schedule:
    - cron: '30 6 * * 1'  # Weekly Monday 6:30 AM UTC
  workflow_dispatch:

jobs:
  stats:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'
          cache: npm

      - run: npm ci

      - name: Generate blog stats
        run: node scripts/generate-blog-stats.mjs

      - name: Generate tag graph
        run: node scripts/generate-tag-graph.mjs

      - name: Summary
        run: |
          node -e "
            const s = require('./static/blog-stats.json');
            const lines = [];
            lines.push('## Blog Analytics');
            lines.push('');
            lines.push('| Metric | Value |');
            lines.push('|--------|-------|');
            lines.push('| Posts | ' + s.totals.posts + ' |');
            lines.push('| Total Words | ' + s.totals.words.toLocaleString() + ' |');
            lines.push('| Avg Words/Post | ' + s.totals.avgWordsPerPost + ' |');
            lines.push('| Unique Tags | ' + s.totals.tags + ' |');
            lines.push('| Code Languages | ' + Object.keys(s.codeLanguages).length + ' |');
            lines.push('| Tag Co-occurrence Edges | ' + s.tagCooccurrence.length + ' |');
            lines.push('');
            lines.push('### Posts per Year');
            lines.push('| Year | Posts |');
            lines.push('|------|-------|');
            for (const [y, c] of Object.entries(s.postsPerYear)) {
              lines.push('| ' + y + ' | ' + c + ' |');
            }
            lines.push('');
            lines.push('### Reading Time Distribution');
            lines.push('| Bucket | Posts |');
            lines.push('|--------|-------|');
            for (const [b, c] of Object.entries(s.readingTimeDistribution)) {
              lines.push('| ' + b + ' | ' + c + ' |');
            }
            lines.push('');
            lines.push('### Top 10 Tags');
            lines.push('| Tag | Count |');
            lines.push('|-----|-------|');
            for (const [t, c] of Object.entries(s.topTags).slice(0, 10)) {
              lines.push('| ' + t + ' | ' + c + ' |');
            }
            lines.push('');
            lines.push('### Top Tag Pairs');
            lines.push('| Pair | Shared Posts |');
            lines.push('|------|-------------|');
            for (const e of s.tagCooccurrence.slice(0, 10)) {
              lines.push('| ' + e.source + ' + ' + e.target + ' | ' + e.weight + ' |');
            }
            lines.push('');
            lines.push('### Word Count Trends');
            lines.push('| Year | Avg Words | Posts |');
            lines.push('|------|-----------|-------|');
            for (const [y, d] of Object.entries(s.wordCountTrends)) {
              lines.push('| ' + y + ' | ' + d.avgWords + ' | ' + d.posts + ' |');
            }
            console.log(lines.join('\n'));
          " >> $GITHUB_STEP_SUMMARY

      - name: Upload tag graph artifacts
        uses: actions/upload-artifact@v4
        with:
          name: tag-graphs
          path: |
            static/images/tag-graph.svg
            static/images/tag-graph-dark.svg
            static/blog-stats.json
          retention-days: 30
